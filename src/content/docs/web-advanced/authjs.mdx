---
title: Auth.js (NextAuth.js) の実践的な認証フロー
description: Next.jsアプリケーションに認証機能を導入するためのAuth.js (NextAuth.js) の詳細な設定、セッション管理、ミドルウェア連携について解説します。
---

import { Aside, Steps } from '@astrojs/starlight/components';
import CodePreviewTabs from '../../../components/CodePreviewTabs.astro';

## はじめに

多くのWebアプリケーションでは、ユーザーが誰であるかを識別し、ユーザーごとに異なる情報や機能を提供するための「認証」機能が不可欠です。
Auth.js（旧 NextAuth.js）は、Next.jsアプリケーションにこのような認証機能を驚くほど簡単に追加できる、非常に人気のあるライブラリです。

「あしたぼホームページ」でも、ユーザー登録やログイン機能を実現するためにAuth.jsが活用されています。
このページでは、Auth.jsの基本的なセットアップから、より実践的な設定、セッション管理のカスタマイズ、そしてミドルウェアを使った高度なアクセスコントロールまでを、具体的なコード例を交えながら詳細に解説します。

{/* ここに「Auth.jsを使った認証フローの概要図（ユーザー → ログインページ → プロバイダ認証 → アプリケーション）」を挿入 */}

### Auth.jsの主な特徴 (再掲)

-   **多様な認証プロバイダ**: Google, GitHub, Lineなど多数のOAuthプロバイダ、メール/パスワード認証などをサポート。
-   **簡単なセットアップ**: Next.jsのAPIルートやミドルウェアと連携し、少ない設定で認証フローを構築。
-   **セッション管理**: CookieベースまたはJWTベースのセッション管理。CSRF保護などのセキュリティ機能も内包。
-   **データベースアダプタ**: Prismaなどと連携し、ユーザー情報やセッションを永続化。
-   **カスタマイズ性**: コールバック関数により認証フローの各ステップを細かく制御可能。

## Auth.jsのコア設定ファイル群

「あしたぼホームページ」におけるAuth.jsの認証設定は、主に以下のファイル群で構成されています。

1.  **`auth.config.ts`**: プロバイダ設定など、Edge環境でも互換性のある基本的な設定を記述します。
2.  **`authOptions.ts` (または `auth.ts`)**: Prismaアダプタの設定、セッション戦略、コールバック関数など、より詳細な認証オプションを定義します。ここで `auth.config.ts` の設定も取り込みます。
3.  **`middleware.ts`**: リクエストに基づいて認証状態をチェックし、アクセス制御やリダイレクトを行います。

### 1. 基本設定 (`auth.config.ts` のイメージ)

ここでは、認証プロバイダ（例: Line）などの基本的な設定を行います。このファイルはEdgeランタイムでも動作するように、データベースアクセスなどを含まない設定に限定されることが多いです。

<CodePreviewTabs filePath="src/components/code_examples/auth/authConfigExample.ts" />
<Aside type="note">
実際のプロジェクトでは、`next-auth` やプロバイダ (`next-auth/providers/line`) を正しくインポートしてください。上記はドキュメント表示用のダミー実装です。
</Aside>

### 2. 詳細な認証オプション (`authOptions.ts` のイメージ)

このファイルで、データベースアダプタ（Prisma）、セッション戦略（JWT）、そして認証フローの挙動をカスタマイズするコールバック関数などを設定します。

<CodePreviewTabs filePath="src/components/code_examples/auth/authOptionsExample.ts" />

**主な設定項目とコールバック解説:**

-   **`adapter: PrismaAdapter(prisma)`**: Prismaをデータベースアダプタとして使用し、ユーザーやセッション情報をデータベースに保存・管理します。
-   **`session: { strategy: 'jwt', maxAge: ... }`**: セッション管理戦略としてJWT (JSON Web Token) を使用します。`maxAge` でセッションの有効期限を設定できます。
-   **`pages: { ... }`**: カスタムのサインインページ、サインアウト後のリダイレクト先、エラーページなどを指定できます。
-   **`callbacks`**:
    -   **`jwt({ token, user, trigger, session })`**: JWTが作成・更新される際に呼び出されます。
        -   初回サインイン時 (`user` オブジェクトが存在する場合): `user.id` をトークンの `sub` (subject) に設定し、データベースからユーザー情報 (`dbUser`) やプロフィール情報 (`dbProfile`) を取得してトークンに含めます。
        -   セッション更新時 (`trigger === 'update'`): `useSession().update()` がクライアントから呼ばれた際などに発火します。データベースから最新のユーザー情報やプロフィール情報を再取得し、トークンを更新します。
        -   既存トークンの検証時: プロフィール情報が欠落している場合などに、再取得してトークンを補完することがあります。
        -   トークンにエラー情報 (`token.error`) を持たせることで、セッションの有効性判断に利用できます。
    -   **`session({ session, token })`**: セッションがアクセスされるたび（例: `useSession`, `getServerSession` 呼び出し時）に呼び出され、クライアントに返されるセッションオブジェクトを構築します。
        -   `jwt` コールバックでトークンに格納した情報（`token.sub`, `token.dbUser`, `token.dbProfile`, `token.error` など）を元に、クライアント側で使いやすいようにセッションオブジェクト (`session.user`, `session.error`) を整形します。
        -   ユーザーのID、名前、メール、ロール、プロフィール情報（`is_profile`, `full_name`, `part`など）をセッションに追加しています。
-   **`cookies`**: セッションやCSRFトークンなどで使用されるCookieの詳細設定（`httpOnly`, `sameSite`, `secure`など）を行えます。

<Aside type="tip">
`jwt` コールバックでデータベースアクセスを行う際は、パフォーマンスへの影響を考慮し、必要な情報のみを取得・格納するようにしましょう。
セッションオブジェクトに含める情報は、クライアントサイドで必要最小限のものに留めるのがセキュリティ上も望ましいです。
</Aside>

### 3. ミドルウェアによるアクセス制御 (`middleware.ts` のイメージ)

ミドルウェアは、特定のパスへのリクエストに対して、認証状態やユーザープロファイルの状況に基づいたアクセス制御やリダイレクト処理を行います。

<CodePreviewTabs filePath="src/components/code_examples/auth/middlewareExample.ts" />

**ミドルウェアの主な処理の流れ:**
-   **`config.matcher`**: ミドルウェアがどのパスに対して実行されるかを定義します。正規表現を使い、静的ファイルやAPIルートなどを除外しています。
-   **ルート定義**: `PROFILE_REQUIRED_ROUTES`, `SESSION_REQUIRED_ROUTES`, `PUBLIC_ROUTES`, `AUTH_FLOW_ROUTES` といった配列で、各ルートのアクセス要件を定義しています。正規表現も利用可能です。
-   **`MiddlewareApp` クラス**: リクエスト処理のロジックをクラスにまとめています。
    -   **メンテナンスモード処理**: 環境変数 `MAINTENANCE_MODE` が `true` の場合、ホワイトリストIP以外のアクセスを `/maintenance` ページにリダイレクトします。
    -   **基本的なリダイレクト**: `/` から `/home` へ、`/auth` から `/auth/padlock` へリダイレクトします。
    -   **`getSessionState()`**: リクエストに付与されたセッション情報 (`request.auth`) を元に、現在のセッション状態を `'no-session'`, `'invalid-session'`, `'session'` (セッションはあるがプロフィール未設定), `'profile'` (プロフィール設定済み) のいずれかで返します。
    -   **各ルートパターンの処理**:
        -   認証フローのルート (`AUTH_FLOW_ROUTES`): ログイン済みなら `/user` や `/auth/signin/setting` へリダイレクト。
        -   プロフィール設定ページ (`/auth/signin/setting`): 未ログインならサインインページへ、設定済みならユーザーページへリダイレクト。
        -   プロフィール必須ルート (`PROFILE_REQUIRED_ROUTES`): セッション状態に応じて、サインインページ、セッション切れページ、プロフィール設定ページへリダイレクト。プロフィール設定済みならアクセス許可。
        -   セッション必須ルート (`SESSION_REQUIRED_ROUTES`): 未ログインならサインインページ、無効セッションならセッション切れページへリダイレクト。
        -   公開ルート (`PUBLIC_ROUTES`): アクセス許可。
    -   **デフォルト処理**: 上記いずれにもマッチしないパスは、ここではプロフィール必須ルートと同様の扱いとしています（プロジェクトの要件に応じて変更）。
-   **`export default auth(...)`**: NextAuth.jsの `auth` 関数でミドルウェア関数をラップすることで、リクエストオブジェクトにセッション情報 (`request.auth`) が自動的に注入されるようになります。

<Aside type="caution">
ミドルウェアはすべての対象リクエストで実行されるため、処理が重くなるとサイト全体のパフォーマンスに影響します。データベースアクセスなど時間のかかる処理は最小限に留め、効率的なロジックを心がけましょう。
</Aside>

## セッションの更新と管理

-   **セッションの自動延長**: Auth.jsは、ユーザーがアクティブである限り、セッションの有効期限を自動的に延長する仕組みを持っています（設定による）。
-   **手動でのセッション更新**: クライアントコンポーネントでユーザー情報（例: プロフィール）が更新された後、現在のセッション情報にもその変更を即座に反映させたい場合があります。その際は、`useSession()` フックから得られる `update` 関数を呼び出すことで、`jwt` コールバックの `trigger === 'update'` のロジックを発火させ、セッション（実質的にはJWTトークン）を最新の情報で更新できます。
    ```tsx
    // クライアントコンポーネント内
    import { useSession } from 'next-auth/react';

    function MyProfilePage() {
      const { data: session, update } = useSession();

      const handleProfileUpdateSuccess = async () => {
        // プロフィール更新API呼び出し成功後...
        await update(); // これでセッションが再取得・更新される
      };
      // ...
    }
    ```
-   **セッションデータの構造**: `authOptions.ts` の `session` コールバックで定義した通り、`session.user` オブジェクトには、基本的なユーザー情報に加え、`dbUser` (PrismaのUserモデルのデータ)、`dbProfile` (カスタムプロフィール情報)、`is_profile` (プロフィール設定済みか否か) など、アプリケーションで必要となる情報が格納されます。

## まとめ

Auth.jsを使いこなすことで、Next.jsアプリケーションに堅牢かつ柔軟な認証システムを構築できます。
-   `auth.config.ts` と `authOptions.ts` で認証プロバイダ、データベースアダプタ、セッション戦略、コールバックを詳細に設定します。
-   `jwt` と `session` コールバックをカスタマイズすることで、セッションに含める情報を自由に制御し、データベースと同期させることができます。
-   `middleware.ts` を活用することで、ページのアクセス制御をきめ細かく行い、ユーザーの状態に応じた適切なリダイレクト処理を実現できます。
-   セッションの手動更新や、サーバー/クライアントコンポーネントでのセッション情報の取得方法を理解することで、よりインタラクティブなアプリケーションが作成可能です。

「あしたぼホームページ」の認証機能は、これらの仕組みを基盤として構築されています。ドキュメントと実際のコードを見比べながら、理解を深めていきましょう。
